# Results

## Preprocess

### Load the data

We read `sas7bdat` file downloaded from United States Census Bureau.

"Adult 1 education, household size, and poverty ratio were imputed using sequential regression imputation methods."

```{r}
library(haven)
library(dplyr)
library(tidyr)
nsch_topical <- read_sas(unz('data/nsch_2022e_topical.sas7bdat.zip',
                             'nsch_2022e_topical.sas7bdat'))
nsch_topical <- nsch_topical[nsch_topical$A1_GRADE_IF != 1, ] # imputed rows
```

### Select & Filter

We select to include relevant columns. For details about the meaning of each column, please refer to `data.qmd`. We only study children between age 6-17, so we filter out the `T1` children.

In the end of preprocessing, we stored the data as a csv file called `nsch.csv` inside the data folder

```{r}
parent_ls <- c("A1_ACTIVE", "A1_AGE", "A1_BORN", "A1_EMPLOYED","A1_GRADE",
               "A1_MARITAL", "A1_MENTHEALTH", "A1_PHYSHEALTH", "FAMILY_R",
               "HHCOUNT", "HIGRADE_TVIS", "HOMEEVIC", "HOPEFUL")
experience_ls <- c("ACE1", "ACE10", "ACE11", "ACE12", "ACE3", "ACE4", "ACE5",
                   "ACE6", "ACE7", "ACE8", "ACE9", "BULLIED_R", "BULLY",
                   "EVERHOMELESS", "GRADES")
physical_ls <- c("FASD", "GENETIC", "HOURSLEEP", "PHYSACTIV", "PHYSICALPAIN")
mental_ls <- c("K2Q30A","K2Q31A","K2Q32A", "K2Q33A",
               "K2Q34A","K2Q35A","K2Q37A","K2Q38A")
treatment_ls <- c("K4Q22_R","K4Q23")
nsch_df <- nsch_topical |>
  select(all_of(c("HHID", "FORMTYPE", parent_ls, experience_ls,
                  physical_ls, mental_ls, treatment_ls))) |>
  filter(FORMTYPE != "T1")

write.csv(nsch_df[,-2], "data/nsch.csv", row.names = FALSE)
```

### Missing Value Analysis

```{r}
nsch_df <- read.csv("data/nsch_dropna.csv") # See Chapter 2
```

### Change to Descriptive Column Names

-   K2Q30A ‐ Learning Disability

-   K2Q31A ‐ ADD/ADHD

-   K2Q32A ‐ Depression

-   K2Q33A ‐ Anxiety

-   K2Q34A ‐ Behavior Problems

-   K2Q35A ‐ Autism ASD

-   K2Q37A ‐ Speech Disorder

-   K2Q38A ‐ Tourette Syndrome

```         
my_dataframe <- my_dataframe %>% 
        rename("id" = "c1",
               "pages" = "c2",
               "name" = "c3")`
```

## Guardian's Influence on Children's Mental Health

### Full-time Employment + Education

```{r}
par_grade_employ <- nsch_df |>
  mutate(Fully_Employed = ifelse(nsch_df$A1_EMPLOYED == 1, "Yes", "No")) |>
  mutate(Child_mental_struggle = ifelse(rowSums(nsch_df[, mental_ls] == 1) > 0,
                                      "Yes", "No")) |>
  group_by(Fully_Employed, A1_GRADE, Child_mental_struggle)|>
  summarize(Freq = n())
  
library(vcd)
mosaic(Child_mental_struggle ~ Fully_Employed + A1_GRADE,
       data=par_grade_employ, direction=c("h", "v", "h")) 
```

**A1_EMPLOYED ‐ Adult 1 ‐ Current Employment Status (T1 T2 T3)**

Which of the following best describes your current employment status?

1 = 8th grade or less

2 = 9th‐12th grade; No diploma

3 = High School Graduate or GED Completed

4 = Completed a vocational, trade, or business school program

5 = Some College Credit, but No Degree

6 = Associate Degree (AA, AS)

7 = Bachelor's Degree (BA, BS, AB)

8 = Master's Degree (MA, MS, MSW, MBA)

9 = Doctorate (PhD, EdD) or Professional Degree (MD, DDS, DVM, JD)

### WIthin children with mental struggles, what's proportion of each problem with respect to A1_MENTHEALTH, facet by FAMILY_R

```{r}
par_mental_famstruc_issues <- nsch_df |>
  mutate(Child_mental_struggle = ifelse(rowSums(nsch_df[, mental_ls] == 1) > 0,
                                      "Yes", "No")) |>
  filter(Child_mental_struggle == "Yes") |>
  pivot_longer(cols = K2Q30A:K2Q38A, names_to = "Issues") |>
  select(all_of(c("FAMILY_R", "A1_MENTHEALTH", "Issues", "value"))) |>
  filter(value == 1) |>
  group_by(FAMILY_R, A1_MENTHEALTH, Issues) |>
  summarize(Freq = n())
```

```{r}
library(ggplot2)
plot_df <- par_mental_famstruc_issues |> group_by(FAMILY_R, A1_MENTHEALTH) |> 
  mutate(Total = sum(Freq)) |> ungroup()
ggplot(plot_df, aes(x = A1_MENTHEALTH, y = Issues)) +
  geom_tile(aes(fill = (Freq/Total)), color = "white") +
  coord_fixed() + 
  scale_fill_gradient(low = "white", high = "red") +
  facet_wrap(~FAMILY_R, ncol = 4) + theme_heat
```

**FAMILY_R ‐ Family Structure (T1 T2 T3)**

1 = Two biogical/adoptive parents, currently married

2 = Two biogical/adoptive parents, not currently married

3 = Two parents (at least one not biological/adoptive), currently married

4 = Two parents (at least one not biological/adoptive), not currently married

5 = Single mother

6 = Single father

7 = Grandparent household

8 = Other relation					

**A1_MENTHEALTH ‐ Adult 1 ‐ Mental or Emotional Health (T1 T2 T3)**

In general, how is your mental or emotional health?

1 = Excellent

2 = Very Good

3 = Good

4 = Fair

5 = Poor

### Treatment

```{r}
library(forcats)
nsch_df |>
  mutate(Treatment = ifelse(nsch_df$K4Q22_R == 1, "Yes", "No")) |>
  pivot_longer(mental_ls, names_to = "Issues") |>
  filter(value == 1) |>
  select(all_of(c("Issues", "Treatment"))) |>
  ggplot(aes(x = fct_infreq(Issues), fill = Treatment)) +
  geom_bar() + labs(x = "Issues")
  
```

```{r}
nsch_df |>
  mutate(Treatment = ifelse(nsch_df$K4Q22_R == 1, "Yes", "No")) |>
  pivot_longer(mental_ls, names_to = "Issues") |>
  filter(value == 1) |>
  select(all_of(c("A1_AGE", "Issues", "Treatment"))) |>
  ggplot(aes(x = A1_AGE, y=Treatment)) +
  geom_boxplot()
```

## Main Results

### Children's experience and mental health

1.  Are children more likely to be depressed if they have been treated unfairly because of gender identity or sexual orientation?

    ```{r}
    library(vcd)
    icecreamcolors <- c("#ff99ff", "#cc9966") 
    unfair_depress <- nsch_df |>
      mutate(Depression = ifelse(nsch_df$K2Q32A == 1, "Yes", "No")) |>
      mutate(Unfair_identity = ifelse(nsch_df$ACE10 == 1, "Yes", "No")) |>
      group_by(Unfair_identity,Depression)|>
      summarize(Freq = n())
    mosaic(Depression ~ Unfair_identity, data=unfair_depress, direction = c("v","h"), main = "Depression and Unfair Treatment from Identity",highlighting_fill = icecreamcolors)
    ```

    To investigate this question, we drew a mosaic plot with two variables:

    unfair_identity: referred as `ACE10` in the original data, showing whether the child has ever experienced unfair treatments because of gender identity or sexual orientation

    depression: referred as `K2Q32A` in the original data, showing whether the child has depression

    We split the dependent variable depression horizontally, and the independent variable unfair_identity vertically. From the mosaic plot, we can see that children who have been treated unfairly because of gender identity or sexual orientation are more likely to have depression.

2.  How does being a victim of violence, living with people with alcohol problems, and experiencing parent divorce affect children's mental health respectively?

    ```{r}
    library(ggplot2)
    library(dplyr)
    library(tidyr)
    victim_mental <- nsch_df |>
      mutate(Child_mental_struggle = ifelse(rowSums(nsch_df[, mental_ls] == 1) > 0,"Yes", "No")) |>
      mutate(Victim_violence = ifelse(nsch_df$ACE7 == 1, "Yes", "No")) |>
      mutate(Alchohol_drug = ifelse(nsch_df$ACE9 == 1, "Yes", "No")) |>
      mutate(Parent_divorce = ifelse(nsch_df$ACE3 == 1, "Yes", "No"))
      #group_by(Victim_violence, Alchohol_drug,Parent_divorce,Child_mental_struggle)|>
      #summarize(Freq = n())
    victim_mental <- select(victim_mental,Child_mental_struggle,Victim_violence,Alchohol_drug,Parent_divorce)
    #pairs(table(victim_mental), highlighting = 2,text_panel=list(cex.labels=0.5))
    victim_mental <- pivot_longer(victim_mental,cols = Victim_violence:Parent_divorce, names_to = "Type",values_to = "Experience" )
    ggplot(victim_mental, aes(x = Experience, fill = Child_mental_struggle)) + 
        geom_bar() + 
        facet_wrap(~Type) +
        scale_fill_manual(values = icecreamcolors)
        
    ```

3.  What's the relationship between children's grade at school and mental health issues

    ```{r}
    library(ggalluvial)
    value_mapping <- data.frame(original=c(1,2,3,4,5,6),
                                replacement=c("Mostly A", "Mostly A and B", "Mostly B and C", "Mostly C and D","Mostly D and E", "Unknown"))
    grade_mental <- nsch_df |>
      mutate(Child_mental_struggle = ifelse(rowSums(nsch_df[, mental_ls] == 1) > 0,"Yes", "No")) |>
      mutate(Grade=value_mapping$replacement[match(GRADES,value_mapping$original)]) |>
      #mutate(Depression = ifelse(nsch_df$K2Q32A == 1, "Yes", "No")) |>
      #mutate(Grade = ifelse(nsch_df$GRADES == 1, "Yes", "No")) |>
      group_by(Grade,Child_mental_struggle)|>
      summarize(Freq = n())

    ggplot(grade_mental, aes(axis1 = Grade, axis2 = Child_mental_struggle, y=Freq)) +
      geom_alluvium(aes(fill = Grade), width = 1/12) +
      geom_stratum() +
      geom_text(stat = "stratum", aes(label = paste(after_stat(stratum)#, "\n", after_stat(count) 
                                                    )))+
      ggtitle("Relationship between Grade at School and Mental Health Issues")
      scale_x_discrete(limits = c("GRADES", "Child_mental_struggle"))
    ```

Children who mostly has C's and D's or D's and E's are much more likely to suffer from mental issues. The better grade a child has, the less likely that child has mental issues. Probably mutual effect

### Mutual effect of mental health problems on children
